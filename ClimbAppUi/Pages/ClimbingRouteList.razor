@page "/climbingRouteList"
@using BlazorBootstrap;
@using BlazorCLIMB.Model.BlazorCRUD.Model;
@using Model
@using Interfaces
@using BlazorCLIMB.UI.Services
@inject IRouteRatingService RouteRatingService
@inject IAuthService AuthService
@inject IClimbingRouteService ClimbingRouteService
@inject NavigationManager NavigationManager

<style>

    .container.full-background {
        height: 100%;
        margin: 0;
        min-height: 100%;
        background-color: #6d7477;
        padding: 0;
    }
    .RadzenDataGrid {
        background-color: transparent; /* O el mismo color del contenedor si es necesario */
    }

    .search-container {
        margin-right:-50px;
        margin-top:-50px;
        display: flex;
        justify-content: center;
    }

    .search-input {
        padding: 10px;
        font-size: 16px;
        border: 2px solid #ccc;
        border-right: none;
        border-top-left-radius: 5px;
        border-bottom-left-radius: 5px;
        width: 250px;
        outline: none;
    }

    .search-button {
        padding: 10px;
        background-color: #5cb85c;
        border: none;
        border-top-right-radius: 5px;
        border-bottom-right-radius: 5px;
        transition: background-color 0.3s;
    }

        .search-button i {
            color: white;
            font-size: 16px; /* Puedes ajustar el tamaño del icono aquí */
        }

        .search-button:hover {
            background-color: #4cae4c;
        }

    .grilla-personalizada {
        background-color: #f2f2f2; /* Cambia este valor al color que desees */
    }
 

    .grilla-container {
        padding: 30px; /* Ajusta el valor de padding según tus preferencias */
        margin-right: -20px;
        margin-top: -40px;
    }

</style>

    <div class="d-flex align-items-center justify-content-between mb-0">
        <h1 style=" color:white; margin-left:33%" >Listado de Vías Escaladas</h1>
        <img src="images/logoClimb.png" alt="ClimbApp Logo" style="margin:10px; height: 4.75rem; border-radius: 50%;" class="logo" />
    </div>
<div class="mb-4 d-flex justify-content-center">
        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="AlignItems.Center" Wrap="Radzen.FlexWrap.Wrap">
        <RadzenButton Click="AddClimbingRoute" Variant="Variant.Outlined" Text="Añadir una Vía" Size="ButtonSize.Large" ButtonStyle="ButtonStyle.Dark" Shade="Shade.Darker" style="font-weight: bold; margin-left:5px;  border:solid 1px white" />
            <RadzenButton Click="LoginGo" Variant="Variant.Outlined" Text="Volver" Size="ButtonSize.Large" ButtonStyle="ButtonStyle.Dark" Shade="Shade.Darker" style="font-weight: bold; margin-left:5px; border:solid 1px white" />
            
        </RadzenStack>
    </div>
  <div class="grilla-container">
    <RadzenDataGrid AllowGrouping="true" AllowFiltering="true" AllowColumnResize="true" FilterMode="FilterMode.Simple" AllowSorting="true" PageSize="5" AllowPaging="true" PagerPosition="PagerPosition.Bottom" AllowPagerText="true" Data="@climbingRoutes">
        <Columns>
            <RadzenDataGridColumn TItem="ClimbingRoute" Property="Name" Title="Nombre" />
            <RadzenDataGridColumn TItem="ClimbingRoute" Property="Grade" Title="Grado" Filterable="true" />
            @* <RadzenDataGridColumn TItem="ClimbingRoute" Property="ClimbingSector" Title="Sector" Filterable="true" /> *@
            <RadzenDataGridColumn TItem="ClimbingRoute" Property="ClimbingSchoolId" Title="Escuela">
                <Template Context="route">
                    @GetSchoolName(route.ClimbingSchoolId)
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="ClimbingRoute" Property="Description" Title="Descripción" />
            <RadzenDataGridColumn Title="Valoración Promedio" TItem="ClimbingRoute">
                <Template Context="route">
                    @route.AverageRating
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn Title="Número de Valoraciones" TItem="ClimbingRoute">
                <Template Context="route">
                    @route.NumberOfRatings
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn Title="Acciones" TItem="ClimbingRoute">
                <Template Context="route">
                    
                   @if (user?.Role == "SuperUser")
                    { 
                        <RadzenButton Variant="Variant.Outlined" Click="() => DeleteClimbingRoute(route.Id)" Icon="delete" ButtonStyle="ButtonStyle.Dark" />
                        <RadzenButton Variant="Variant.Outlined" Click="() => EditClimbingRoute(route.Id)" Icon="edit" ButtonStyle="ButtonStyle.Primary" />
                    }
                    <RadzenButton Variant="Variant.Outlined" Click="() => AnotarViaEscalada(route.Id)" Icon="check" ButtonStyle="ButtonStyle.Success" />

                </Template>
            </RadzenDataGridColumn>
        </Columns>
    </RadzenDataGrid>
</div>
    @if (!string.IsNullOrEmpty(loadingError))
    {
        <p>@loadingError</p>
    }



<!-- Modal para Editar/Agregar Rutas -->
<BlazorBootstrap.Modal @ref="modal" Title="Editar Ruta" Style="background-color:#e5e8ed;">
    <BodyTemplate>
        <div class="mb-3">
            <label for="name" class="form-label">Nombre:</label>
            <input type="text" class="form-control" id="name" @bind="selectedRoute.Name" />
        </div>
        <div class="mb-3">
            <label for="grade" class="form-label">Grado:</label>
            <input type="text" class="form-control" id="grade" @bind="selectedRoute.Grade" />
        </div>
        <div class="mb-3">
            <label for="sector" class="form-label">Sector:</label>
            <input type="text" class="form-control" id="sector" @bind="selectedRoute.ClimbingSector" />
        </div>
        <div class="mb-3">
            <label for="school" class="form-label">Escuela:</label>
            <select class="form-select" id="school" @bind="selectedRoute.ClimbingSchoolId">
                <option value="1">Cuenca</option>
                <option value="2">Entrepeñas</option>
                <option value="3">Fin del Mundo</option>
                <option value="4">Patones</option>
            </select>
        </div>
        <div class="mb-3">
            <label for="description" class="form-label">Descripción:</label>
            <textarea class="form-control" id="description" rows="4" @bind="selectedRoute.Description"></textarea>
        </div>
    </BodyTemplate>
    <FooterTemplate>
        <button class="btn btn-secondary" @onclick="OnHideModalClick">Cancelar</button>
        <button class="btn btn-primary" @onclick="SaveClimbingRoute">Guardar</button>

    </FooterTemplate>
</BlazorBootstrap.Modal>

@code {

    private BlazorBootstrap.Modal modal;
    private IEnumerable<ClimbingRoute> climbingRoutes;
    private string loadingError;
    private ClimbingRoute selectedRoute = new ClimbingRoute();
    private double averageRating;
    private int numberOfRatings;
    private User user;
    

    protected override async Task OnInitializedAsync()
    {
        int userId = UserSession.UserId; 
        if (userId != 0)
        {
        user = await AuthService.GetUserById(userId);
        }

        try
        {
            climbingRoutes = await ClimbingRouteService.GetAllClimbingRoutes();
            CalculateAverageRatingAndNumberOfRatingsForEachRoute();
        }
        catch (Exception ex)
        {
            loadingError = "An error occurred while loading the routes: " + ex.Message;
            climbingRoutes = Enumerable.Empty<ClimbingRoute>();
        }
    }
    private void OnRender(DataGridRenderEventArgs<ClimbingRoute> args)
    {
        if (args.FirstRender)
        {
            args.Grid.Groups.Add(new GroupDescriptor() { Property = "ClimbingSchoolId" });
            StateHasChanged();
        }
    }

    private void AnotarViaEscalada(int routeId)
    {
        NavigationManager.NavigateTo($"/userRoutes/{routeId}");
    }
    private string GetSchoolName(int climbingSchoolId)
    {
        switch (climbingSchoolId)
        {
            case 1:
                return "Cuenca";
            case 2:
                return "Entrepeñas";
            case 3:
                return "Fin del Mundo";
            case 4:
                return "Patones";
            default:
                return "Desconocida";
        }
    }

    private void EditClimbingRoute(int routeId)
    {
        selectedRoute = climbingRoutes.FirstOrDefault(r => r.Id == routeId);
        modal.ShowAsync();
    }

    private void AddClimbingRoute()
    {
        selectedRoute = new ClimbingRoute();
        modal.ShowAsync();
    }
    private void LoginGo()
    {
        NavigationManager.NavigateTo("/");
    }

    private async Task DeleteClimbingRoute(int routeId)
    {
        try
        {
            await ClimbingRouteService.DeleteClimbingRoute(routeId);
            climbingRoutes = await ClimbingRouteService.GetAllClimbingRoutes();
        }
        catch (Exception ex)
        {
            loadingError = "An error occurred while deleting the route: " + ex.Message;
        }
    }

    private async Task SaveClimbingRoute()
    {
        if (selectedRoute.Id != 0)
        {
            await ClimbingRouteService.UpdateClimbingRoute(selectedRoute);
        }
        else
        {
            await ClimbingRouteService.InsertClimbingRoute(selectedRoute);
        }

        modal.HideAsync();
        climbingRoutes = await ClimbingRouteService.GetAllClimbingRoutes();
    }

    private void OnHideModalClick()
    {
        modal.HideAsync();
    }
 
        private string searchTerm = string.Empty;

        private void ApplySearch()
        {
            // Implementa la lógica de búsqueda aquí
        }

        private Task SearchKeyPress(KeyboardEventArgs args)
        {
            if (args.Key == "Enter")
            {
                ApplySearch();
            }
            return Task.CompletedTask;
        }
    private async Task CalculateAverageRatingAndNumberOfRatingsForEachRoute()
    {
        foreach (var route in climbingRoutes)
        {
            // Calcula la valoración promedio y el número de valoraciones para cada vía escalada individualmente
            double totalRating = 0.0;
            int totalRatings = 0;

            // Llama a GetAverageRating para obtener el promedio de calificaciones para esta vía
            route.AverageRating = await RouteRatingService.GetAverageRating(route.Id);

            // Obtén el número de valoraciones para esta vía
            totalRatings = await RouteRatingService.GetNumberOfRatings(route.Id);

            // Asigna el número de valoraciones a la propiedad de la vía escalada actual
            route.NumberOfRatings = totalRatings;
        }
    }
}